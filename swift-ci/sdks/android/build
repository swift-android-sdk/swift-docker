#!/bin/bash -ex
# Swift Android SDK: Top-level Build Script

# the architecture(s) to build
ARCH=aarch64
#ARCH=x86_64,aarch64
NDK=android-ndk-r27c
API=28

SDKROOT=${TMPDIR:-/tmp}/swift-android-sdk
mkdir -p ${SDKROOT}

# fetch the patches
PATCHDIR=${SDKROOT}/patches
if [[ ! -d ${PATCHDIR} ]]; then
    git clone https://github.com/finagolfin/swift-android-sdk.git ${PATCHDIR}
fi

HOST_TOOLCHAIN=${HOST_TOOLCHAIN:-$(dirname $(dirname $(which swiftc)))}
#HOST_TOOLCHAIN=${HOST_TOOLCHAIN:-${HOME}/.local/share/swiftly/toolchains/6.1.0/usr}

${HOST_TOOLCHAIN}/bin/swift --version

export ANDROID_NDK_HOME=${SDKROOT}/ndk/${NDK}
export ANDROID_NDK=${ANDROID_NDK_HOME}

if [[ ! -d ${ANDROID_NDK_HOME} ]]; then
    mkdir -p $(dirname ${ANDROID_NDK_HOME})
    pushd $(dirname ${ANDROID_NDK_HOME})
    NDKFILE=$(basename $ANDROID_NDK_HOME)-linux.zip
    wget https://dl.google.com/android/repository/${NDKFILE}
    unzip ${NDKFILE}
    popd
fi

mkdir -p ${SDKROOT}/products

# Check-out the sources
if [[ ! -d ${SDKROOT}/src ]]; then
    scripts/fetch-source.sh --source-dir ${SDKROOT}/src
fi

if [[ ! -d ${SDKROOT}/src ]]; then
    ./scripts/fetch-source.sh --source-dir ${SDKROOT}/src
fi

./scripts/build.sh --patch-dir ${PATCHDIR} --products-dir ${SDKROOT}/products --source-dir ${SDKROOT}/src --build-dir ${SDKROOT}/build --ndk-home ${ANDROID_NDK_HOME} --android-api ${API} --host-toolchain ${HOST_TOOLCHAIN} --archs $ARCH

